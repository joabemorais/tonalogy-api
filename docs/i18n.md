# Internacionalização (i18n) - TonalogyAPI

## Visão Geral

O sistema de internacionalização do TonalogyAPI permite suporte a múltiplos idiomas, com inglês como idioma padrão e português brasileiro como idioma adicional.

## Estrutura

```
core/i18n/
├── __init__.py          # Módulo principal de i18n
├── locale_manager.py    # Gerenciamento de locales
├── translator.py        # Sistema de tradução
├── middleware.py        # Middleware FastAPI (opcional)
└── locales/
    ├── en.json          # Traduções em inglês (padrão)
    └── pt_br.json       # Traduções em português brasileiro
```

## Configuração

### 1. Importar o sistema de tradução

```python
from core.i18n import T, LocaleManager
```

### 2. Usar traduções no código

```python
# Tradução simples
message = T("api.welcome_message")

# Tradução com variáveis
error = T("errors.chord_fulfills_function", 
          chord_name="C", 
          function_name="TONIC", 
          tonality_name="C Major")
```

### 3. Configurar middleware (FastAPI)

```python
from core.i18n import I18nMiddleware

app = FastAPI()
app.add_middleware(I18nMiddleware)
```

## Detecção de Idioma

O sistema detecta o idioma do usuário usando:

1. **Parâmetro de query**: `?lang=pt_br`
2. **Header Accept-Language**: `Accept-Language: pt-BR,pt;q=0.9,en;q=0.8`
3. **Fallback**: Inglês (padrão)

## Idiomas Suportados

- `en` - Inglês (padrão)
- `pt_br` - Português Brasileiro

## Exemplos de Uso

### API Responses

```python
# Antes (hardcoded)
return {"error": "Cannot visualize a non-tonal progression."}

# Depois (internacionalizado)
return {"error": T("errors.cannot_visualize_non_tonal")}
```

### Mensagens de Análise

```python
# Antes
observation = f"Chord '{chord_name}' fulfills function '{function_name}' in '{tonality_name}'."

# Depois
observation = T("analysis.messages.chord_fulfills_function",
                chord_name=chord_name,
                function_name=function_name,
                tonality_name=tonality_name)
```

### Mudança de Contexto de Idioma

```python
from core.i18n import locale_manager

# Temporariamente mudar idioma
with locale_manager.locale_context("pt_br"):
    message = T("api.welcome_message")  # Retorna versão em português
```

## Adicionando Novas Traduções

### 1. Adicionar chave no arquivo en.json

```json
{
  "new_section": {
    "new_message": "New message in English with {variable}"
  }
}
```

### 2. Adicionar tradução no arquivo pt_br.json

```json
{
  "new_section": {
    "new_message": "Nova mensagem em português com {variable}"
  }
}
```

### 3. Usar no código

```python
message = T("new_section.new_message", variable="valor")
```

## Testando Traduções

### Via Query Parameter

```bash
curl "http://localhost:8000/?lang=pt_br"
curl "http://localhost:8000/analyze?lang=pt_br" -X POST -H "Content-Type: application/json" -d '{"chords": ["C", "G", "Am", "F"]}'
```

### Via Accept-Language Header

```bash
curl -H "Accept-Language: pt-BR,pt;q=0.9" "http://localhost:8000/"
```

## Estrutura dos Arquivos de Tradução

```json
{
  "api": {
    "title": "...",
    "description": "...",
    "welcome_message": "..."
  },
  "endpoints": {
    "analyze": {
      "summary": "...",
      "description": "..."
    }
  },
  "schemas": {
    "campo": {
      "description": "..."
    }
  },
  "errors": {
    "error_type": "Mensagem de erro com {variable}"
  },
  "analysis": {
    "messages": {
      "message_type": "Mensagem com {variable}"
    },
    "rules": {
      "rule_name": "Nome da Regra"
    }
  }
}
```

## Boas Práticas

1. **Use chaves descritivas**: `errors.cannot_visualize_non_tonal` em vez de `error1`
2. **Organize por contexto**: `api.*`, `errors.*`, `analysis.*`
3. **Use variáveis**: `{chord_name}` em vez de concatenação
4. **Mantenha consistência**: Mesma estrutura em todos os arquivos de tradução
5. **Teste ambos idiomas**: Sempre teste en e pt_br

## Troubleshooting

### Traduções não aparecem

1. Verifique se o arquivo JSON está bem formatado
2. Verifique se a chave existe em ambos idiomas
3. Verifique se o middleware está configurado

### Variáveis não funcionam

1. Use `{variable_name}` no JSON
2. Passe as variáveis como kwargs: `T("key", variable_name=value)`

### Fallback não funciona

1. Verifique se existe tradução em inglês (fallback)
2. Verifique se o LocaleManager está configurado corretamente
