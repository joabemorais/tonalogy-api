# Internationalization (i18n) - TonalogyAPI

## Overview

The TonalogyAPI internationalization system provides support for multiple languages, with English as the default language and Brazilian Portuguese as an additional language.

## Structure

```
core/i18n/
├── __init__.py          # Main i18n module
├── locale_manager.py    # Locale management
├── translator.py        # Translation system
├── middleware.py        # FastAPI middleware (optional)
└── locales/
    ├── en.json          # English translations (default)
    └── pt_br.json       # Brazilian Portuguese translations
```

## Configuration

### 1. Import the translation system

```python
from core.i18n import T, LocaleManager
```

### 2. Use translations in code

```python
# Simple translation
message = T("api.welcome_message")

# Translation with variables
error = T("errors.chord_fulfills_function", 
          chord_name="C", 
          function_name="TONIC", 
          tonality_name="C Major")
```

### 3. Configure middleware (FastAPI)

```python
from core.i18n import I18nMiddleware

app = FastAPI()
app.add_middleware(I18nMiddleware)
```

## Language Detection

The system detects user language using:

1. **Query parameter**: `?lang=pt_br`
2. **Accept-Language header**: `Accept-Language: pt-BR,pt;q=0.9,en;q=0.8`
3. **Fallback**: English (default)

## Supported Languages

- `en` - English (default)
- `pt_br` - Brazilian Portuguese

## Usage Examples

### API Responses

```python
# Before (hardcoded)
return {"error": "Cannot visualize a non-tonal progression."}

# After (internationalized)
return {"error": T("errors.cannot_visualize_non_tonal")}
```

### Analysis Messages

```python
# Before
observation = f"Chord '{chord_name}' fulfills function '{function_name}' in '{tonality_name}'."

# After
observation = T("analysis.messages.chord_fulfills_function",
                chord_name=chord_name,
                function_name=function_name,
                tonality_name=tonality_name)
```

### Language Context Change

```python
from core.i18n import locale_manager

# Temporarily change language
with locale_manager.locale_context("pt_br"):
    message = T("api.welcome_message")  # Returns Portuguese version
```

## Adding New Translations

### 1. Add key to en.json file

```json
{
  "new_section": {
    "new_message": "New message in English with {variable}"
  }
}
```

### 2. Add translation to pt_br.json file

```json
{
  "new_section": {
    "new_message": "Nova mensagem em português com {variable}"
  }
}
```

### 3. Use in code

```python
message = T("new_section.new_message", variable="valor")
```

## Testing Translations

### Via Query Parameter

```bash
curl "http://localhost:8000/?lang=pt_br"
curl "http://localhost:8000/analyze?lang=pt_br" -X POST -H "Content-Type: application/json" -d '{"chords": ["C", "G", "Am", "F"]}'
```

### Via Accept-Language Header

```bash
curl -H "Accept-Language: pt-BR,pt;q=0.9" "http://localhost:8000/"
```

## Translation Files Structure

```json
{
  "api": {
    "title": "...",
    "description": "...",
    "welcome_message": "..."
  },
  "endpoints": {
    "analyze": {
      "summary": "...",
      "description": "..."
    }
  },
  "schemas": {
    "field": {
      "description": "..."
    }
  },
  "errors": {
    "error_type": "Error message with {variable}"
  },
  "analysis": {
    "messages": {
      "message_type": "Message with {variable}"
    },
    "rules": {
      "rule_name": "Rule Name"
    }
  }
}
```

## Best Practices

1. **Use descriptive keys**: `errors.cannot_visualize_non_tonal` instead of `error1`
2. **Organize by context**: `api.*`, `errors.*`, `analysis.*`
3. **Use variables**: `{chord_name}` instead of concatenation
4. **Maintain consistency**: Same structure in all translation files
5. **Test both languages**: Always test en and pt_br

## Troubleshooting

### Translations don't appear

1. Check if the JSON file is properly formatted
2. Check if the key exists in both languages
3. Check if the middleware is configured

### Variables don't work

1. Use `{variable_name}` in JSON
2. Pass variables as kwargs: `T("key", variable_name=value)`

### Fallback doesn't work

1. Check if English translation exists (fallback)
2. Check if LocaleManager is configured correctly
